<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:integration="http://www.springframework.org/schema/integration" xmlns:http="http://www.springframework.org/schema/integration/http"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
                                 http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                                 http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http-1.0.xsd
                                 http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-1.0.xsd">

	<bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver" />

	<bean id="bodyInboundRequestMapper" class="org.springframework.batch.admin.web.BodyInboundRequestMapper" />

	<bean id="reload-job-executions" class="org.springframework.web.servlet.view.RedirectView">
		<property name="url" value="#{resourceService.servletPath}/jobs/executions" />
		<property name="contextRelative" value="true" />
	</bean>

	<http:inbound-channel-adapter name="/job-requests" channel="job-launches" request-mapper="bodyInboundRequestMapper"
		view="reload-job-executions" />
		
	<http:inbound-gateway name="/job-requests.txt" request-channel="job-launches" reply-channel="job-operator" request-mapper="bodyInboundRequestMapper"
		view="jobs/execution.txt" reply-key="jobExecution"/>
	
	<http:inbound-channel-adapter name="/job-restarts" channel="job-restarts" request-mapper="bodyInboundRequestMapper"
		view="reload-job-executions" />

	<bean id="configurationFileRequestMapper" class="org.springframework.integration.http.DataBindingInboundRequestMapper">
		<property name="targetType" value="org.springframework.batch.admin.integration.MultipartJobConfigurationRequest" />
		<property name="webBindingInitializer">
			<bean class="org.springframework.batch.admin.web.CustomWebBindingInitializer" />
		</property>
	</bean>

	<bean name="redirect:jobs" class="org.springframework.web.servlet.view.RedirectView">
		<property name="url" value="#{resourceService.servletPath}/jobs" />
		<property name="contextRelative" value="true" />
	</bean>

	<bean name="redirect:files" class="org.springframework.web.servlet.view.RedirectView">
		<property name="url" value="#{resourceService.servletPath}/files" />
		<property name="contextRelative" value="true" />
	</bean>

	<integration:channel id="job-configuration-multipart" />

	<integration:transformer id="multipartToJobConfigurationRequest" input-channel="job-configuration-multipart"
		output-channel="job-configuration-requests">
		<bean class="org.springframework.batch.admin.integration.MultipartToJobConfigurationRequestTransformer"/>
	</integration:transformer>

	<http:inbound-channel-adapter name="/job-configuration-multipart" channel="job-configuration-multipart"
		request-mapper="configurationFileRequestMapper" view="redirect:jobs" supported-methods="POST"/>

	<http:inbound-channel-adapter name="/job-configuration-files" channel="job-configuration-files"
		request-mapper="bodyInboundRequestMapper" view="redirect:jobs" supported-methods="POST"/>

	<http:inbound-channel-adapter name="/files" channel="file-requests" request-mapper="inputFileRequestMapper"
		view="redirect:files" supported-methods="POST" />

	<bean id="inputFileRequestMapper" class="org.springframework.integration.http.DataBindingInboundRequestMapper">
		<property name="targetType" value="org.springframework.batch.admin.integration.FileUploadRequest" />
		<property name="webBindingInitializer">
			<bean class="org.springframework.batch.admin.web.CustomWebBindingInitializer" />
		</property>
	</bean>

	<integration:service-activator input-channel="file-requests" output-channel="input-files">
		<bean class="org.springframework.batch.admin.integration.FileUploadRequestToFileAdapter" />
	</integration:service-activator>

</beans>
